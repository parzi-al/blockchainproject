<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Communication Dashboard</title>
    
    <!-- External CSS and Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
        }
        .container {
            margin-top: 30px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .graph-container {
            height: 300px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 class="text-center my-4">Blockchain Communication Dashboard</h2>

        <!-- Dashboard Cards -->
        <div class="row">
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Connected Clients</h5>
                    <ul id="clients" class="list-group"></ul>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Performance Metrics</h5>
                    <p><strong>Total Messages:</strong> <span id="messageCount">0</span></p>
                    <p><strong>Active Clients:</strong> <span id="clientCount">0</span></p>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Usage Frequency</h5>
                    <canvas id="usageChart" class="graph-container"></canvas>
                </div>
            </div>
        </div>

        <!-- Message Logs -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card p-3">
                    <h5>Message Logs</h5>
                    <button class="btn btn-primary mb-2" onclick="fetchAllMessages()">Show All Messages</button>
                    <ul id="messages" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        var socket = io();
        var usageChart;
        var messageHistory = [];

        function fetchClients() {
            $.get("/clients", function(data) {
                $("#clientCount").text(Object.keys(data).length);
                let clientsList = "";
                for (let name in data) {
                    clientsList += `<li class="list-group-item">${name} - ${data[name]}</li>`;
                }
                $("#clients").html(clientsList);
            });
        }

        function fetchAllMessages() {
            $.get("/messages", function(data) {
                messageHistory = data;
                $("#messageCount").text(data.length);
                let msgList = "";
                data.forEach(msg => {
                    msgList += `<li class="list-group-item"><strong>${msg.sender} â†’ ${msg.receiver}:</strong> ${msg.message} <em>(${msg.timestamp})</em></li>`;
                });
                $("#messages").html(msgList);
                updateGraph();
            });
        }

        function updateGraph() {
            let messageCounts = {};
            messageHistory.forEach(msg => {
                let date = msg.timestamp.split(" ")[0];
                messageCounts[date] = (messageCounts[date] || 0) + 1;
            });

            let labels = Object.keys(messageCounts);
            let values = Object.values(messageCounts);

            if (usageChart) usageChart.destroy();
            let ctx = document.getElementById("usageChart").getContext("2d");
            usageChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Messages Sent",
                        data: values,
                        backgroundColor: "rgba(54, 162, 235, 0.2)",
                        borderColor: "rgba(54, 162, 235, 1)",
                        borderWidth: 2
                    }]
                }
            });
        }

        socket.on("update_clients", function() {
            fetchClients();
        });

        socket.on("new_message", function() {
            fetchAllMessages();
        });

        $(document).ready(function() {
            fetchClients();
            fetchAllMessages();
        });
    </script>

</body>
</html>
